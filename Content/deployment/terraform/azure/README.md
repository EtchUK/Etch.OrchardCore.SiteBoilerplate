# Terraform Azure Provider Script

This directory contains a [Terraform](https://www.terraform.io) script for the [Azure provider](https://www.terraform.io/docs/providers/azurerm/index.html) which will generate all the required infrastructure for your [Orchard Core](https://orchardcore.readthedocs.io) site generated by this boilerplate project.

## Running Locally

For testing the script locally you would need to install the [Terraform command line interface](https://www.terraform.io/downloads.html) and [Azure command line interface](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) then [sign in with your Azure CLI](https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest).

Testing the local script is best carried out from the `resources` directory, run `terraform init` to initialize Terraform and `terraform plan` to check what your script will create. If you wish to test the script fully you can use `terraform apply` to actually generate the resources but best practice would be to run the scripts through an automated CD process. If you do not wish to do this it would be wise to at least use [Remote State](https://www.terraform.io/docs/state/remote.html).

It is recommended to create a local [TF variables file](https://learn.hashicorp.com/terraform/getting-started/variables.html#from-a-file) for quicker testing without having to enter variables on every execution.

## Running in CD

This script has been created with the intent that it runs within a CD process, it was developed specifically for use in [Azure DevOps](https://azure.microsoft.com/en-in/services/devops/) but should work in other environments too. The script itself is environment agnostic (hence passing in `ENV` variable described below) and should be run at the deployment step with specific variables set at that level per environment.

## Structure

The site configuration itself is implemented as a module under the `resources` directory, this top level acts as an interface onto this module and any future ones.

## Variables

* `ENV` - Environment for this instance of infrastructure (e.g.: `dev`)
* `HOSTNAMES` - List of strings for hostnames to bind (these must already have CNAME validation set up)
* `LE_CLIENT_ID` - [Lets Encrypt Site Extension](https://github.com/sjkp/letsencrypt-siteextension) Client ID
* `LE_CLIENT_SECRET` - [Lets Encrypt Site Extension](https://github.com/sjkp/letsencrypt-siteextension) Client Secret
* `LE_SUBSCRIPTION_ID` - [Lets Encrypt Site Extension](https://github.com/sjkp/letsencrypt-siteextension) Azure Subscription ID
* `LE_TENANT` - [Lets Encrypt Site Extension](https://github.com/sjkp/letsencrypt-siteextension) Tenant Name
* `PROJECT` - Project name, will be cleaned by the script so can be the regular name (e.g.: Etch Play Site)
* `RG_NAME` - Name of resource group to deploy into, must already exist
* `RG_NAME_ALT` - Optional name of 'major' region resource group in case `RG_NAME` doesn't support certain resources like CDN
* `SP_NAME` - Name of service plan to deploy into, must already exist
* `SQL_SERVER_NAME` - Name of SQL Server to deploy into, must already exist

A note on `ENV` and `PROJECT`, these will be used together to create names for resources, invalid characters will be removed and spaces will be replaced with `-`.

## Outputs

* `APP_SERVICE_NAME` - Name of main app service, can be used with [deployment tools](https://marketplace.visualstudio.com/items?itemName=raul-arrieta.terraform-outputs) to immediately deploy into created infrastructure.
